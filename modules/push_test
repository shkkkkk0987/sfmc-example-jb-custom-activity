'use strict';
const fetch = require('node-fetch');

module.exports = {
  key: 'push_test',                  // 모듈 key (폴더명과 동일하게)
  name: 'Pushy Push Test',           // Journey Builder에서 표시될 이름
  icon: 'images/icon.png',           // 아이콘 경로 (없으면 기본)
  category: 'message',               // 메시지 유형 (message, email 등)

  // 실행 구간 (Journey에서 실행될 때 호출)
  async execute(inArguments) {
    const args = inArguments[0] || {};

    // Journey Builder에서 전달받는 값
    const deviceToken = args.deviceToken;
    const title = args.title || '테스트 발송';
    const message = args.message || '푸시 메시지 내용';

    if (!deviceToken) {
      console.error('❌ deviceToken 값이 없습니다.');
      throw new Error('deviceToken is required');
    }

    // Pushy REST API 엔드포인트
    const apiUrl = `https://api.pushy.me/push?api_key=${process.env.PUSHY_API_KEY}`;

    // 전송할 payload
    const payload = {
      to: deviceToken,
      data: {
        title,
        message
      },
      notification: {
        title,
        body: message,
        icon: 'ic_notification'
      }
    };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      console.log('✅ Pushy API result:', result);
      return result;
    } catch (err) {
      console.error('❌ Pushy API send error:', err);
      throw err;
    }
  }
};
